(function(){
	'use strict';

	theApp
		.controller('DashboardController', DashboardController);

		DashboardController.$inject = ['$scope', '$rootScope', '$uibModal', '$timeout', '$location', '$filter', 'WSService', 'DashboardService'];
		function DashboardController($scope, $rootScope, $uibModal, $timeout, $location, $filter, WSService, DashboardService){					
			
			
			$scope.itemList = [
				{
					id: 1,
					name: "Cơm sườn",
					price: 25000
				},
				{
					id: 2,
					name: "Cơm sườn trứng",
					price: 30000
				},
				{
					id: 3,
					name: "Cafe đen đá",
					price: 10000
				},
				{
					id: 4,
					name: "Cafe sữa đá",
					price: 15000
				},
				{
					id: 5,
					name: "Sinh tố",
					price: 20000
				}
			];

			$scope.itemSelectedList = [];
			$scope.amount = 0;
			$scope.modalInstance = null;

			$scope.safeApply = function(fn) {
	            if (this.$root) {
	                var phase = this.$root.$$phase;
	                if (phase == '$apply' || phase == '$digest') {
	                    if (fn && (typeof (fn) === 'function')) {
	                        fn();
	                    }
	                } else {
	                    this.$apply(fn);
	                }
	            }
	        };

			$scope.selectItem = function(item) {

				var itemSelected;
				if ($scope.itemSelectedList.length > 0) {
					itemSelected = $filter('filter')($scope.itemSelectedList, {id: item.id})[0];
				}
				
				if (typeof itemSelected === "undefined") {
					$scope.itemSelectedList.push({
						id: item.id,
						name: item.name,
						price: item.price,
						quantity: 1
					});
					$scope.amount += item.price;
				} else {
					itemSelected.quantity += 1;
					$scope.amount += itemSelected.price;
				}
			};

			$scope.removeSelectItem = function(index) {
				var itemSelected;
				if ($scope.itemSelectedList.length > 0) {
					itemSelected = $scope.itemSelectedList[index];
				}

				if (typeof itemSelected !== "undefined") {
					$scope.amount -= itemSelected.price;

					if (itemSelected.quantity > 1) {
						itemSelected.quantity -= 1;
					} else {
						$scope.itemSelectedList.splice(index, 1);
					}
				}
			};

			$scope.calAmount = function() {
				$scope.amount = 0;
				for (var i in $scope.itemSelectedList) {
					$scope.amount += $scope.itemSelectedList.quantity * $scope.itemSelectedList.price;
				}
			};

			function getCurrentDateTime() {
				var today = new Date();
				var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
				var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
				var CurrentDateTime = date+' '+time;
				return CurrentDateTime;
			}

			WSService.addCallBack(MSG_S2C_PAYMENT_DONE, function(jsonObj) {
				console.log("MSG_S2C_PAYMENT_DONE");
				console.log(jsonObj);
				if ($scope.modalInstance) {
					$scope.modalInstance.close('');
					$scope.modalInstance = null;
				}
			});

			$scope.payment = function (size, parentSelector) {
			    
			    $scope.qrInfo = "";
				DashboardService.sendCreateOrder($scope.amount, $scope.itemSelectedList)
					.then(function(response){
						console.log("send create order response");
						console.log(response);
						if(response.returncode === 1){
							$scope.qrInfo = response.data.qrinfo;
							$scope.showQRcode(size, parentSelector);
						} else{
							console.log("error send create order");
						}
					});
			    
			};

			$scope.showQRcode = function (size, parentSelector) {
				$scope.modalInstance = $uibModal.open({
					// animation: true,
					templateUrl: 'qrcode.html',
					controller: 'ShowQRcodeController',
					controllerAs: '$ctrl',
					size: size,
					backdrop: 'static',
                	keyboard: false,
					resolve: {
						qrInfo: function () {
							return $scope.qrInfo;
						}
					}
			    });

			    $scope.modalInstance.result.then(function (selectedItem) {
			    }, function () {
			    	$scope.modalInstance = null;
			    });
			};

		};

		theApp.controller('ShowQRcodeController', function ($scope, $uibModalInstance, qrInfo) {
			
			$scope.qrInfo = qrInfo;
			//$scope.qrInfoStr = "lkskdfjlskdjfl";
			$scope.qrInfoStr = $scope.qrInfo;
			//$scope.qrInfoStr = JSON.stringify($scope.qrInfo);
			//$scope.qrInfoStr = "{\"appid\":33,\"appuser\":\"Zalopay Integration\",\"apptime\":\"1489386509321\",\"amount\":\"25000\",\"apptransid\":\"170313132829\",\"embeddata\":\"123456\",\"item\":\"[{\\\"id\\\":1,\\\"name\\\":\\\"Cơm sườn\\\",\\\"price\\\":25000,\\\"quantity\\\":1,\\\"$$hashKey\\\":\\\"object:49\\\"}]\",\"description\":\"Bán Hàng\",\"mac\":\"7fbacb1a90d648422bb5bea314e68bedc49e244e8b60c9b89878d969597e9d01\"}";
			console.log("qr = ");
			console.log($scope.qrInfoStr);
		});


})();